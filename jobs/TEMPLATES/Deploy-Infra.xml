<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.40">
  <description>Deploy Infra Job</description>
  <keepDependencies>false</keepDependencies>

  <properties>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>

        <!-- ACTION parameter -->
        <hudson.model.StringParameterDefinition>
          <name>ACTION</name>
          <description>Action to perform: PLAN or APPLY</description>
          <defaultValue>PLAN</defaultValue>
        </hudson.model.StringParameterDefinition>

        <!-- ENV parameter -->
        <hudson.model.StringParameterDefinition>
          <name>ENV</name>
          <description>Environment (dev or prod)</description>
          <defaultValue>dev</defaultValue>
        </hudson.model.StringParameterDefinition>

        <!-- Parent workspace path -->
        <hudson.model.StringParameterDefinition>
          <name>PARENT_WORKSPACE</name>
          <description>Parent job workspace path</description>
          <defaultValue></defaultValue>
        </hudson.model.StringParameterDefinition>

      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>

  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition">
    <script><![CDATA[
pipeline {
  agent any
  options {
    disableConcurrentBuilds()
  }

  stages {
    stage('Deploy Infra') {
      steps {
        script {
          def terraformBin = sh(script: '''which terraform 2>/dev/null || \
            (test -f /usr/local/bin/terraform && echo /usr/local/bin/terraform) || \
            (test -f /usr/bin/terraform && echo /usr/bin/terraform) || \
            (test -f /opt/homebrew/bin/terraform && echo /opt/homebrew/bin/terraform) || \
            echo "terraform"''', returnStdout: true).trim()
          echo "Using Terraform: ${terraformBin}"
          
          withCredentials([[
            $class: 'AmazonWebServicesCredentialsBinding',
            credentialsId: 'aws-creds',
            accessKeyVariable: 'AWS_ACCESS_KEY_ID',
            secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
          ]]) {
            
            sh """
              # Detect OS for path configuration
              OS=\$(uname -s)
              if [ "\$OS" = "Darwin" ]; then
                JENKINS_HOME="\$HOME/.jenkins"
              else
                JENKINS_HOME="/var/lib/jenkins"
              fi
              
              # Create centralized terraform state directories
              mkdir -p \${JENKINS_HOME}/workspace/terraform-states/dev
              mkdir -p \${JENKINS_HOME}/workspace/terraform-states/prod
              mkdir -p \${JENKINS_HOME}/workspace/terraform-states/backups
              
              # Define state file path
              STATE_FILE="\${JENKINS_HOME}/workspace/terraform-states/${params.ENV}/terraform.tfstate"
              
              # Run terraform
              cd ${params.PARENT_WORKSPACE}/url_infra/labs/${params.ENV}
              export AWS_ACCESS_KEY_ID="\${AWS_ACCESS_KEY_ID}"
              export AWS_SECRET_ACCESS_KEY="\${AWS_SECRET_ACCESS_KEY}"
              ${terraformBin} init
            """

            if (params.ACTION == 'PLAN') {
              sh """
                # Detect OS for path configuration
                OS=\$(uname -s)
                if [ "\$OS" = "Darwin" ]; then
                  JENKINS_HOME="\$HOME/.jenkins"
                else
                  JENKINS_HOME="/var/lib/jenkins"
                fi
                
                STATE_FILE="\${JENKINS_HOME}/workspace/terraform-states/${params.ENV}/terraform.tfstate"
                
                cd ${params.PARENT_WORKSPACE}/url_infra/labs/${params.ENV}
                export AWS_ACCESS_KEY_ID="\${AWS_ACCESS_KEY_ID}"
                export AWS_SECRET_ACCESS_KEY="\${AWS_SECRET_ACCESS_KEY}"
                ${terraformBin} plan \\
                  -var-file=../${params.ENV}.tfvars \\
                  -state=\${STATE_FILE}
              """
            } else if (params.ACTION == 'APPLY') {
              sh """
                # Detect OS for path configuration
                OS=\$(uname -s)
                if [ "\$OS" = "Darwin" ]; then
                  JENKINS_HOME="\$HOME/.jenkins"
                else
                  JENKINS_HOME="/var/lib/jenkins"
                fi
                
                STATE_FILE="\${JENKINS_HOME}/workspace/terraform-states/${params.ENV}/terraform.tfstate"
                
                cd ${params.PARENT_WORKSPACE}/url_infra/labs/${params.ENV}
                export AWS_ACCESS_KEY_ID="\${AWS_ACCESS_KEY_ID}"
                export AWS_SECRET_ACCESS_KEY="\${AWS_SECRET_ACCESS_KEY}"
                ${terraformBin} apply \\
                  -var-file=../${params.ENV}.tfvars \\
                  -state=\${STATE_FILE} \\
                  -auto-approve
              """
            }

          }
        }
      }
    }
    
    stage('Backup State') {
      when {
        expression { params.ACTION == 'APPLY' }
      }
      steps {
        script {
          echo 'ðŸ“¦ Backing up terraform state...'
          sh """
            # Detect OS for path configuration
            OS=\$(uname -s)
            if [ "\$OS" = "Darwin" ]; then
              JENKINS_HOME="\$HOME/.jenkins"
            else
              JENKINS_HOME="/var/lib/jenkins"
            fi
            
            STATE_FILE="\${JENKINS_HOME}/workspace/terraform-states/${params.ENV}/terraform.tfstate"
            
            # Check if state file exists
            if [ -f "\${STATE_FILE}" ]; then
              # Create backup directory
              BACKUP_DIR="\${JENKINS_HOME}/workspace/terraform-states/backups/${params.ENV}"
              mkdir -p "\${BACKUP_DIR}"
              
              # Create backup with timestamp
              TIMESTAMP=\$(date +%Y%m%d_%H%M%S)
              BACKUP_FILE="\${BACKUP_DIR}/tfstate.\${TIMESTAMP}"
              
              # Copy state file to backup location
              if cp "\${STATE_FILE}" "\${BACKUP_FILE}"; then
                echo "âœ… Backup completed: \${BACKUP_FILE}"
              else
                echo "âš ï¸  Backup failed but continuing pipeline..."
              fi
            else
              echo "âš ï¸  No state file found, skipping backup"
            fi
          """
        }
      }
    }
  }
}
    ]]></script>
    <sandbox>true</sandbox>
  </definition>

  <triggers/>
  <disabled>false</disabled>
</flow-definition>
