<?xml version='1.1' encoding='UTF-8'?>
<flow-definition plugin="workflow-job@2.40">
  <description>Destroy Infra Job</description>
  <keepDependencies>false</keepDependencies>

  <properties>
    <com.sonyericsson.rebuild.RebuildSettings plugin="rebuild@1.33">
      <autoRebuild>false</autoRebuild>
      <rebuildDisabled>false</rebuildDisabled>
    </com.sonyericsson.rebuild.RebuildSettings>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>

        <!-- ACTION parameter -->
        <hudson.model.StringParameterDefinition>
          <name>ACTION</name>
          <description>Action to perform: PLAN or DESTROY</description>
          <defaultValue>PLAN</defaultValue>
          <trim>true</trim>
        </hudson.model.StringParameterDefinition>

        <!-- ENV parameter -->
        <hudson.model.StringParameterDefinition>
          <name>ENV</name>
          <description>Environment: dev or prod</description>
          <defaultValue>dev</defaultValue>
          <trim>true</trim>
        </hudson.model.StringParameterDefinition>

        <!-- Parent workspace path -->
        <hudson.model.StringParameterDefinition>
          <name>PARENT_WORKSPACE</name>
          <description>Parent job workspace path</description>
          <defaultValue></defaultValue>
        </hudson.model.StringParameterDefinition>

      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>

  <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition">
    <script><![CDATA[
pipeline {
  agent any
  options {
    disableConcurrentBuilds()
  }

  stages {
    stage('Destroy Infra') {
      steps {
        script {
          def terraformBin = sh(script: '''which terraform 2>/dev/null || \
            (test -f /usr/local/bin/terraform && echo /usr/local/bin/terraform) || \
            (test -f /usr/bin/terraform && echo /usr/bin/terraform) || \
            (test -f /opt/homebrew/bin/terraform && echo /opt/homebrew/bin/terraform) || \
            echo "terraform"''', returnStdout: true).trim()
          echo "Using Terraform: ${terraformBin}"
          
          withCredentials([[
            $class: 'AmazonWebServicesCredentialsBinding',
            credentialsId: 'aws-creds',
            accessKeyVariable: 'AWS_ACCESS_KEY_ID',
            secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
          ]]) {

            sh """
              # Detect OS for path configuration
              OS=\$(uname -s)
              if [ "\$OS" = "Darwin" ]; then
                JENKINS_HOME="\$HOME/.jenkins"
              else
                JENKINS_HOME="/var/lib/jenkins"
              fi
              
              STATE_FILE="\${JENKINS_HOME}/workspace/terraform-states/${params.ENV}/terraform.tfstate"
              
              # Backup existing state before destroy
              if [ -f "\${STATE_FILE}" ]; then
                echo "ðŸ“¦ Backing up terraform state before destroy..."
                
                # Create backup directory
                BACKUP_DIR="\${JENKINS_HOME}/workspace/terraform-states/backups/${params.ENV}"
                mkdir -p "\${BACKUP_DIR}"
                
                # Create backup with timestamp
                TIMESTAMP=\$(date +%Y%m%d_%H%M%S)
                BACKUP_FILE="\${BACKUP_DIR}/tfstate.\${TIMESTAMP}"
                
                # Copy state file to backup location
                if cp "\${STATE_FILE}" "\${BACKUP_FILE}"; then
                  echo "âœ… Backup completed: \${BACKUP_FILE}"
                else
                  echo "âš ï¸  Backup failed but continuing..."
                fi
              fi
              
              # Run terraform
              cd ${params.PARENT_WORKSPACE}/url_infra/labs/${params.ENV}
              export AWS_ACCESS_KEY_ID="\${AWS_ACCESS_KEY_ID}"
              export AWS_SECRET_ACCESS_KEY="\${AWS_SECRET_ACCESS_KEY}"
              ${terraformBin} init
            """

            if (params.ACTION == 'PLAN') {
              sh """
                # Detect OS for path configuration
                OS=\$(uname -s)
                if [ "\$OS" = "Darwin" ]; then
                  JENKINS_HOME="\$HOME/.jenkins"
                else
                  JENKINS_HOME="/var/lib/jenkins"
                fi
                
                STATE_FILE="\${JENKINS_HOME}/workspace/terraform-states/${params.ENV}/terraform.tfstate"
                
                cd ${params.PARENT_WORKSPACE}/url_infra/labs/${params.ENV}
                export AWS_ACCESS_KEY_ID="\${AWS_ACCESS_KEY_ID}"
                export AWS_SECRET_ACCESS_KEY="\${AWS_SECRET_ACCESS_KEY}"
                ${terraformBin} plan \\
                  -var-file=../${params.ENV}.tfvars \\
                  -state=\${STATE_FILE} \\
                  -destroy
              """
            } else if (params.ACTION == 'DESTROY') {
              sh """
                # Detect OS for path configuration
                OS=\$(uname -s)
                if [ "\$OS" = "Darwin" ]; then
                  JENKINS_HOME="\$HOME/.jenkins"
                else
                  JENKINS_HOME="/var/lib/jenkins"
                fi
                
                STATE_FILE="\${JENKINS_HOME}/workspace/terraform-states/${params.ENV}/terraform.tfstate"
                
                cd ${params.PARENT_WORKSPACE}/url_infra/labs/${params.ENV}
                export AWS_ACCESS_KEY_ID="\${AWS_ACCESS_KEY_ID}"
                export AWS_SECRET_ACCESS_KEY="\${AWS_SECRET_ACCESS_KEY}"
                ${terraformBin} destroy \\
                  -var-file=../${params.ENV}.tfvars \\
                  -state=\${STATE_FILE} \\
                  -auto-approve
              """
            }

          }
        }
      }
    }
  }
}
    ]]></script>
    <sandbox>true</sandbox>
  </definition>

  <triggers/>
  <disabled>false</disabled>
</flow-definition>
